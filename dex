#!/usr/bin/env bash
# AKAOIO DEX - Smart tmux session manager with adaptive layouts
# Automatically adjusts panel layout based on screen size and orientation

set -e

# Colors for output - Dracula theme
PURPLE='\033[38;2;189;147;249m'  # BD93F9
GREEN='\033[38;2;80;250;123m'    # 50FA7B
CYAN='\033[38;2;139;233;253m'    # 8BE9FD
PINK='\033[38;2;255;121;198m'    # FF79C6
YELLOW='\033[38;2;241;250;140m'  # F1FA8C
RED='\033[38;2;255;85;85m'       # FF5555
ORANGE='\033[38;2;255;184;108m'  # FFB86C
COMMENT='\033[38;2;98;114;164m'  # 6272A4
NC='\033[0m' # No Color

# Session name (can be customized via argument)
SESSION_NAME="${1:-dev}"

# Detect screen dimensions
get_screen_info() {
    # Try to get terminal dimensions
    COLS=$(tput cols 2>/dev/null || echo 80)
    LINES=$(tput lines 2>/dev/null || echo 24)
    
    # Determine if mobile/narrow screen
    if [ "$COLS" -lt 100 ]; then
        SCREEN_TYPE="mobile"
    else
        SCREEN_TYPE="desktop"
    fi
    
    # Determine orientation
    if [ "$COLS" -gt "$LINES" ]; then
        ORIENTATION="landscape"
    else
        ORIENTATION="portrait"
    fi
}

# Setup enhanced UI with header and footer
setup_enhanced_ui() {
    # Configure status bar (bottom position)
    tmux set -t "$SESSION_NAME" status-position bottom
    tmux set -t "$SESSION_NAME" status on
    tmux set -t "$SESSION_NAME" status-interval 1
    tmux set -t "$SESSION_NAME" status-style "bg=#282A36,fg=#F8F8F2"
    
    # Status left: Session name
    tmux set -t "$SESSION_NAME" status-left-length 40
    tmux set -t "$SESSION_NAME" status-left "#[fg=#BD93F9,bold][#S] "
    
    # Status center: Current window with nice formatting
    tmux set -t "$SESSION_NAME" status-justify centre
    tmux setw -t "$SESSION_NAME" window-status-format "#[fg=#6272A4]#I:#W"
    tmux setw -t "$SESSION_NAME" window-status-current-format "#[fg=#F8F8F2,bold,bg=#BD93F9] #I:#W "
    
    # Status right: Pane info + time
    tmux set -t "$SESSION_NAME" status-right-length 60
    tmux set -t "$SESSION_NAME" status-right "#[fg=#8BE9FD]%H:%M"
    
    # Setup key bindings for UI controls
    setup_ui_keybindings
    
    # Setup script paths for global access
    setup_script_paths
}


# Setup UI keybindings
setup_ui_keybindings() {
    
    # Quick help (Ctrl-a + ?)
    tmux bind -T prefix ? display-popup -E -w 80% -h 80% "bash ~/.tmux/dex-help.sh"
    
    # Session manager popup (Ctrl-a + Ctrl-s)
    tmux bind -T prefix C-s display-popup -E -w 60% -h 60% "tmux choose-session -F '#{session_name}: #{?session_attached,attached,not attached}'"
    
    # Window manager popup (Ctrl-a + Ctrl-w)
    tmux bind -T prefix C-w display-popup -E -w 60% -h 60% "tmux choose-window -F '#{window_index}: #{window_name} #{?window_active,(active),}'"
    
    # Pane manager popup (Ctrl-a + Ctrl-p)
    tmux bind -T prefix C-p display-popup -E -w 60% -h 60% "tmux choose-pane -F '#{pane_index}: #{pane_current_command} #{?pane_active,(active),}'"
    
    # Footer controls - add keybinding for footer toggle
    tmux bind -T prefix f run-shell "bash ~/.tmux/dex-footer.sh toggle"
}

# Setup script paths for global access
setup_script_paths() {
    # Ensure ~/.tmux directory exists
    mkdir -p ~/.tmux
    
    # Copy scripts from terminal project to user's tmux directory
    # This happens during dex execution to ensure latest versions
    local script_source_dir
    
    # Try to find the terminal project directory
    if [ -d "/home/$(whoami)/Projects/terminal/configs/tmux-scripts" ]; then
        script_source_dir="/home/$(whoami)/Projects/terminal/configs/tmux-scripts"
    elif [ -d "$HOME/akaoio/terminal/configs/tmux-scripts" ]; then
        script_source_dir="$HOME/akaoio/terminal/configs/tmux-scripts"
    elif [ -f "$0" ]; then
        # Get directory where dex is located
        local dex_dir=$(dirname "$(readlink -f "$0")")
        script_source_dir="$dex_dir/configs/tmux-scripts"
    fi
    
    if [ -d "$script_source_dir" ]; then
        echo -e "${CYAN}Setting up DEX UI scripts...${NC}"
        cp "$script_source_dir/"*.sh ~/.tmux/
        chmod +x ~/.tmux/dex-*.sh
        
        # Create debug log file
        touch "/tmp/dex-debug.log"
        chmod 666 "/tmp/dex-debug.log"
        
        echo -e "${GREEN}âœ“ Scripts installed and configured${NC}"
    else
        echo -e "${YELLOW}Warning: Could not find tmux scripts directory${NC}"
        echo -e "${YELLOW}UI features may not work properly${NC}"
    fi
}


# Create smart layout based on screen
create_smart_layout() {
    get_screen_info
    
    echo -e "${CYAN}Screen: ${SCREEN_TYPE} (${COLS}x${LINES}) - ${ORIENTATION}${NC}"
    
    # Check if session exists
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        echo -e "${YELLOW}Session '$SESSION_NAME' exists. Attaching...${NC}"
        tmux attach-session -t "$SESSION_NAME"
        exit 0
    fi
    
    echo -e "${GREEN}Creating new session '$SESSION_NAME' with smart layout...${NC}"
    
    # Create new session with first window
    tmux new-session -d -s "$SESSION_NAME" -n "main"
    
    # Adaptive layout based on screen type and orientation
    if [ "$SCREEN_TYPE" = "mobile" ]; then
        if [ "$ORIENTATION" = "portrait" ]; then
            # Mobile portrait: 2 vertical panes
            echo -e "${CYAN}Layout: Mobile Portrait (2 vertical panes)${NC}"
            tmux split-window -v -t "$SESSION_NAME:main"
            
            # Adjust pane sizes (60/40 split)  
            tmux resize-pane -t "$SESSION_NAME:main.1" -p 60
            
        else
            # Mobile landscape: 2 horizontal panes
            echo -e "${CYAN}Layout: Mobile Landscape (2 horizontal panes)${NC}"
            tmux split-window -h -t "$SESSION_NAME:main"
            
            # Equal split
            tmux select-layout -t "$SESSION_NAME:main" even-horizontal
        fi
    else
        # Desktop: 4 panes in grid
        if [ "$COLS" -gt 160 ]; then
            # Wide desktop: 4 panes in 2x2 grid
            echo -e "${CYAN}Layout: Desktop Wide (2x2 grid)${NC}"
            
            # Create 4 panes in grid layout
            tmux split-window -h -t "$SESSION_NAME:main"
            tmux split-window -v -t "$SESSION_NAME:main.1"
            tmux split-window -v -t "$SESSION_NAME:main.3"
            
            # Arrange in tiled layout
            tmux select-layout -t "$SESSION_NAME:main" tiled
            
        elif [ "$ORIENTATION" = "portrait" ]; then
            # Desktop portrait: 3 panes stacked
            echo -e "${CYAN}Layout: Desktop Portrait (3 stacked panes)${NC}"
            
            tmux split-window -v -t "$SESSION_NAME:main"
            tmux split-window -v -t "$SESSION_NAME:main.1"
            
            # Adjust sizes for better balance
            tmux select-layout -t "$SESSION_NAME:main" even-vertical
            
        else
            # Standard desktop: 4 panes with main + 3 small
            echo -e "${CYAN}Layout: Desktop Standard (1 main + 3 side)${NC}"
            
            # Create main pane on left, 3 smaller on right
            tmux split-window -h -t "$SESSION_NAME:main" -p 40
            tmux split-window -v -t "$SESSION_NAME:main.2" -p 66
            tmux split-window -v -t "$SESSION_NAME:main.3" -p 50
        fi
    fi
    
    # Set pane titles based on their purpose
    if [ "$SCREEN_TYPE" = "mobile" ]; then
        tmux send-keys -t "$SESSION_NAME:main.1" "# Main workspace" C-m
        if tmux list-panes -t "$SESSION_NAME:main" | grep -q "^2:"; then
            tmux send-keys -t "$SESSION_NAME:main.2" "# Terminal" C-m
        fi
    else
        tmux send-keys -t "$SESSION_NAME:main.1" "# Main workspace" C-m
        if tmux list-panes -t "$SESSION_NAME:main" | grep -q "^2:"; then
            tmux send-keys -t "$SESSION_NAME:main.2" "# Git/Commands" C-m
        fi
        if tmux list-panes -t "$SESSION_NAME:main" | grep -q "^3:"; then
            tmux send-keys -t "$SESSION_NAME:main.3" "# Logs/Output" C-m
        fi
        if tmux list-panes -t "$SESSION_NAME:main" | grep -q "^4:"; then
            tmux send-keys -t "$SESSION_NAME:main.4" "# Testing/Debug" C-m
        fi
    fi
    
    # Focus on first pane
    tmux select-pane -t "$SESSION_NAME:main.1"
    
    # Create additional windows for organization
    tmux new-window -t "$SESSION_NAME:2" -n "editor"
    tmux new-window -t "$SESSION_NAME:3" -n "servers"
    
    # Return to main window
    tmux select-window -t "$SESSION_NAME:main"
    
    # Setup enhanced UI
    setup_enhanced_ui
    
    # Display session info
    echo -e "${GREEN}âœ“ Session '$SESSION_NAME' created successfully!${NC}"
    echo -e "${GREEN}âœ“ $(ls ~/.tmux/plugins/ | wc -l) professional plugins loaded${NC}"
    echo -e "${CYAN}Windows:${NC}"
    echo -e "  1. main   - Development workspace"
    echo -e "  2. editor - File editing"
    echo -e "  3. servers - Background services"
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${CYAN}                     ESSENTIAL SHORTCUTS                     ${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}UI Controls:${NC}      ${YELLOW}Ctrl-a + ?${NC} help  ${YELLOW}Ctrl-a + f${NC} footer"
    echo -e "${GREEN}Split & Navigate:${NC}  ${YELLOW}Ctrl-a + |/-${NC} split  ${YELLOW}Alt+arrows${NC} navigate"
    echo -e "${GREEN}Windows:${NC}          ${YELLOW}Ctrl-a + c${NC} new  ${YELLOW}Ctrl-a + n/p${NC} switch  ${YELLOW}Ctrl-a + 1-9${NC} goto"
    echo -e "${GREEN}Sessions:${NC}         ${YELLOW}Ctrl-a + d${NC} detach  ${YELLOW}Ctrl-a + s${NC} browser  ${YELLOW}tmux attach${NC}"
    echo -e "${GREEN}Power Features:${NC}   ${YELLOW}Ctrl-a + z${NC} zoom  ${YELLOW}Ctrl-a + S${NC} sync  ${YELLOW}Ctrl-a + Space${NC} layouts"
    echo ""
    echo -e "${CYAN}Pro tip:${NC} Auto-save enabled â€¢ Sessions persist across reboots"
    echo -e "${CYAN}More help:${NC} ${YELLOW}dex --shortcuts${NC} (all keys) â€¢ ${YELLOW}dex --plugins${NC} (features)"
    echo ""
}

# Handle session restoration
restore_or_create() {
    # Check if we should restore previous session
    if [ -f "$HOME/.tmux-resurrect/last" ]; then
        echo -e "${YELLOW}Found previous session data${NC}"
        read -p "Restore previous session? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            tmux new-session -d -s temp 2>/dev/null || true
            tmux send-keys -t temp "tmux resurrect-restore" C-m
            sleep 2
            tmux kill-session -t temp 2>/dev/null || true
            tmux attach-session -t "$SESSION_NAME" 2>/dev/null || create_smart_layout
            return
        fi
    fi
    
    create_smart_layout
}

# Show comprehensive help
show_help() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘                           AKAOIO DEX v2.0                               â•‘${NC}"
    echo -e "${CYAN}â•‘                    Professional Tmux Session Manager                    â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${GREEN}USAGE:${NC}"
    echo -e "  ${YELLOW}dex${NC}                    Create smart session (auto-named)"
    echo -e "  ${YELLOW}dex <name>${NC}             Create named session"  
    echo -e "  ${YELLOW}dex --help${NC}             Show this help"
    echo -e "  ${YELLOW}dex --shortcuts${NC}        Complete shortcut reference"
    echo -e "  ${YELLOW}dex --plugins${NC}          Plugin management & status"
    echo ""
    echo -e "${GREEN}FEATURES:${NC}"
    echo -e "  ${CYAN}Smart Layouts${NC}      Adapts to terminal size automatically"
    echo -e "  ${CYAN}Plugin System${NC}      10 professional tmux plugins included"
    echo -e "  ${CYAN}Session Persistence${NC} Auto-save/restore across reboots"
    echo -e "  ${CYAN}Mobile Friendly${NC}    Optimized shortcuts for small screens"
    echo ""
    echo -e "${GREEN}ADAPTIVE LAYOUTS:${NC}"
    echo -e "  ${YELLOW}Mobile Portrait${NC}   2 vertical panes (narrow screens)"
    echo -e "  ${YELLOW}Mobile Landscape${NC}  2 horizontal panes (small screens)"  
    echo -e "  ${YELLOW}Desktop Standard${NC}  4 panes: 1 main + 3 auxiliary"
    echo -e "  ${YELLOW}Desktop Wide${NC}      4 panes in 2Ã—2 grid (wide screens)"
    echo -e "  ${YELLOW}Desktop Portrait${NC}  3 stacked panes (tall screens)"
    echo ""
    echo -e "${GREEN}EXAMPLES:${NC}"
    echo -e "  ${YELLOW}dex${NC}                    # Create 'dev' session"
    echo -e "  ${YELLOW}dex frontend${NC}           # Create 'frontend' session"
    echo -e "  ${YELLOW}dex api-server${NC}         # Create 'api-server' session"
    echo ""
    exit 0
}

# Install and setup tmux plugins
setup_tmux_plugins() {
    echo -e "${CYAN}Checking tmux plugins...${NC}"
    
    # Check if TPM is installed
    if [ ! -d "$HOME/.tmux/plugins/tpm" ]; then
        echo -e "${YELLOW}Installing TPM (Tmux Plugin Manager)...${NC}"
        git clone --quiet https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
    fi
    
    # Check if plugins are installed
    local plugins_installed=false
    for plugin in "tmux-sensible" "tmux-resurrect" "tmux-continuum" "tmux-pain-control" "tmux-copycat" "tmux-yank" "tmux-open" "vim-tmux-navigator" "tmux-prefix-highlight"; do
        if [ ! -d "$HOME/.tmux/plugins/$plugin" ]; then
            plugins_installed=false
            break
        fi
    done
    
    # Install plugins if not present
    if [ "$plugins_installed" = false ]; then
        echo -e "${YELLOW}Installing tmux plugins (this may take a moment)...${NC}"
        
        # Start a temporary tmux session to install plugins
        tmux new-session -d -s plugin_install 2>/dev/null || true
        
        # Run plugin installation
        ~/.tmux/plugins/tpm/bin/install_plugins >/dev/null 2>&1 || true
        
        # Kill the temporary session
        tmux kill-session -t plugin_install 2>/dev/null || true
        
        echo -e "${GREEN}âœ“ Tmux plugins installed${NC}"
    else
        echo -e "${GREEN}âœ“ Tmux plugins already installed${NC}"
    fi
}

# Main execution
main() {
    # Check if tmux is installed
    if ! command -v tmux &> /dev/null; then
        echo -e "${YELLOW}tmux is not installed. Please run the terminal installer first.${NC}"
        echo -e "curl -fsSL https://raw.githubusercontent.com/akaoio/terminal/main/install.sh | bash"
        exit 1
    fi
    
    # Setup plugins before creating session
    setup_tmux_plugins
    
    # Check if we're actually in a tmux session (not just env variable)
    if [ -n "$TMUX" ] && tmux list-sessions 2>/dev/null | grep -q "attached"; then
        echo -e "${YELLOW}Already in tmux session${NC}"
        echo -e "${CYAN}Creating new window instead...${NC}"
        tmux new-window -n "dev"
        exit 0
    fi
    
    # Create or attach to session
    restore_or_create
    
    # Attach to the session
    echo -e "${CYAN}Attaching to session '$SESSION_NAME'...${NC}"
    tmux attach-session -t "$SESSION_NAME"
}

# Show complete shortcuts reference
show_shortcuts() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘                        TMUX SHORTCUTS REFERENCE                         â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${GREEN}ğŸ¯ UI CONTROLS (NEW!):${NC}"
    echo -e "  ${YELLOW}Ctrl-a + ?${NC}           Quick help popup"
    echo -e "  ${YELLOW}Ctrl-a + Ctrl-s${NC}      Session manager popup"
    echo -e "  ${YELLOW}Ctrl-a + Ctrl-w${NC}      Window manager popup"
    echo -e "  ${YELLOW}Ctrl-a + Ctrl-p${NC}      Pane manager popup"
    echo ""
    echo -e "${GREEN}PANE MANAGEMENT:${NC}"
    echo -e "  ${YELLOW}Ctrl-a + |${NC}           Split horizontally (side by side)"
    echo -e "  ${YELLOW}Ctrl-a + -${NC}           Split vertically (top/bottom)"
    echo -e "  ${YELLOW}Ctrl-a + h${NC}           Split horizontal (alternative)"
    echo -e "  ${YELLOW}Ctrl-a + v${NC}           Split vertical (alternative)"
    echo -e "  ${YELLOW}Ctrl-a + z${NC}           Toggle pane zoom (fullscreen)"
    echo -e "  ${YELLOW}Ctrl-a + x${NC}           Close current pane (with confirmation)"
    echo ""
    echo -e "${GREEN}PANE NAVIGATION:${NC}"
    echo -e "  ${YELLOW}Alt + â†‘â†“â†â†’${NC}           Navigate panes (no prefix needed)"
    echo -e "  ${YELLOW}Ctrl-a + j/k/h/l${NC}     Navigate panes (vim-style)"
    echo -e "  ${YELLOW}Ctrl-a + q${NC}           Show pane numbers"
    echo -e "  ${YELLOW}Ctrl-a + Space${NC}       Cycle through layouts"
    echo ""
    echo -e "${GREEN}WINDOW MANAGEMENT:${NC}"
    echo -e "  ${YELLOW}Ctrl-a + c${NC}           Create new window"
    echo -e "  ${YELLOW}Ctrl-a + n/p${NC}         Next/previous window"
    echo -e "  ${YELLOW}Ctrl-a + 0-9${NC}         Switch to window by number"
    echo -e "  ${YELLOW}Ctrl-a + w${NC}           Interactive window browser"
    echo -e "  ${YELLOW}Ctrl-a + ,${NC}           Rename current window"
    echo -e "  ${YELLOW}Ctrl-a + &${NC}           Close window (with confirmation)"
    echo ""
    echo -e "${GREEN}SESSION CONTROL:${NC}"
    echo -e "  ${YELLOW}Ctrl-a + d${NC}           Detach from session"
    echo -e "  ${YELLOW}Ctrl-a + s${NC}           Interactive session browser"
    echo -e "  ${YELLOW}Ctrl-a + \$${NC}           Rename session"
    echo -e "  ${YELLOW}tmux ls${NC}              List all sessions"
    echo -e "  ${YELLOW}tmux attach${NC}          Attach to last session"
    echo -e "  ${YELLOW}tmux attach -t <name>${NC} Attach to named session"
    echo ""
    echo -e "${GREEN}PROFESSIONAL FEATURES (Plugins):${NC}"
    echo -e "  ${YELLOW}Ctrl-a + S${NC}           Toggle pane synchronization"
    echo -e "  ${YELLOW}Ctrl-a + Escape${NC}      Enter copy mode (vim-like)"
    echo -e "  ${YELLOW}Ctrl-a + Ctrl-s${NC}      Save session state"
    echo -e "  ${YELLOW}Ctrl-a + Ctrl-r${NC}      Restore session state"
    echo -e "  ${YELLOW}Ctrl-a + /${NC}           Search in pane history"
    echo -e "  ${YELLOW}Ctrl-a + u${NC}           Search & open URLs"
    echo -e "  ${YELLOW}Ctrl-a + I${NC}           Install new plugins"
    echo -e "  ${YELLOW}Ctrl-a + U${NC}           Update all plugins"
    echo ""
    echo -e "${GREEN}COPY MODE (after Ctrl-a + Escape):${NC}"
    echo -e "  ${YELLOW}v${NC}                    Start selection"
    echo -e "  ${YELLOW}y${NC}                    Copy selection to clipboard"
    echo -e "  ${YELLOW}r${NC}                    Rectangle selection mode"
    echo -e "  ${YELLOW}q${NC}                    Exit copy mode"
    echo ""
    exit 0
}

# Show plugin info if requested
show_plugins() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘                    TMUX PROFESSIONAL PLUGINS                 â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${GREEN}Installed Plugins:${NC}"
    
    if [ -d "$HOME/.tmux/plugins" ]; then
        for plugin_dir in ~/.tmux/plugins/*/; do
            if [ -d "$plugin_dir" ]; then
                plugin_name=$(basename "$plugin_dir")
                case "$plugin_name" in
                    "tpm")
                        echo -e "  ${YELLOW}$plugin_name${NC}              - Tmux Plugin Manager"
                        ;;
                    "tmux-sensible")
                        echo -e "  ${YELLOW}$plugin_name${NC}      - Basic tmux settings everyone can agree on"
                        ;;
                    "tmux-resurrect")
                        echo -e "  ${YELLOW}$plugin_name${NC}     - Restore tmux environment after system restart"
                        ;;
                    "tmux-continuum")
                        echo -e "  ${YELLOW}$plugin_name${NC}     - Continuous saving of tmux environment"
                        ;;
                    "tmux-pain-control")
                        echo -e "  ${YELLOW}$plugin_name${NC}  - Standard pane key-bindings for tmux"
                        ;;
                    "tmux-copycat")
                        echo -e "  ${YELLOW}$plugin_name${NC}       - Enhanced search & copy functionality"
                        ;;
                    "tmux-yank")
                        echo -e "  ${YELLOW}$plugin_name${NC}          - Copy to system clipboard"
                        ;;
                    "tmux-open")
                        echo -e "  ${YELLOW}$plugin_name${NC}          - Open highlighted selection"
                        ;;
                    "vim-tmux-navigator")
                        echo -e "  ${YELLOW}$plugin_name${NC} - Seamless vim/tmux navigation"
                        ;;
                    "tmux-prefix-highlight")
                        echo -e "  ${YELLOW}$plugin_name${NC} - Show when prefix key is pressed"
                        ;;
                    *)
                        echo -e "  ${YELLOW}$plugin_name${NC}"
                        ;;
                esac
            fi
        done
        echo ""
        echo -e "${CYAN}Total: $(ls ~/.tmux/plugins/ | wc -l) plugins installed${NC}"
    else
        echo -e "  ${YELLOW}No plugins installed${NC}"
    fi
    
    echo ""
    echo ""
    echo -e "${GREEN}PLUGIN MANAGEMENT:${NC}"
    echo -e "  ${YELLOW}Ctrl-a + I${NC}             Install new plugins from config"
    echo -e "  ${YELLOW}Ctrl-a + U${NC}             Update all installed plugins"  
    echo -e "  ${YELLOW}Ctrl-a + alt + u${NC}       Clean unused plugins"
    echo -e "  ${YELLOW}dex --shortcuts${NC}        View shortcuts provided by plugins"
    echo ""
    echo -e "${GREEN}AUTO-ENABLED FEATURES:${NC}"
    echo -e "  ${CYAN}â€¢ Session Persistence${NC}   Auto-save/restore every 15 minutes"
    echo -e "  ${CYAN}â€¢ System Clipboard${NC}      Copy/paste integrates with OS"
    echo -e "  ${CYAN}â€¢ Enhanced Search${NC}       Advanced search & URL opening"
    echo -e "  ${CYAN}â€¢ Vim Integration${NC}       Seamless navigation with vim/nvim"
    echo -e "  ${CYAN}â€¢ Smart Defaults${NC}        Optimized tmux settings included"
    echo ""
    exit 0
}

# Check for help flag first  
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    show_help
fi

# Check for shortcuts flag
if [ "$1" = "--shortcuts" ] || [ "$1" = "-s" ]; then
    show_shortcuts
fi

# Check for plugins flag
if [ "$1" = "--plugins" ] || [ "$1" = "-p" ]; then
    show_plugins
fi

# Run main function
main